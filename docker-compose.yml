services:
  web:
    build:
      context: .
      dockerfile_inline: |
        FROM node:20-alpine AS builder
        WORKDIR /app
        COPY package*.json ./
        RUN npm ci
        COPY . .
        RUN npm run build

        FROM nginx:alpine
        COPY --from=builder /app/dist /usr/share/nginx/html
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
    ports:
      - "80:80"
    restart: unless-stopped
    configs:
      - source: nginx_config
        target: /etc/nginx/conf.d/default.conf

configs:
  nginx_config:
    content: |
      server {
          listen 80;
          server_name _;

          root /usr/share/nginx/html;
          index index.html;

          gzip on;
          gzip_vary on;
          gzip_min_length 1024;
          gzip_proxied expired no-cache no-store private auth;
          gzip_types
              text/plain
              text/css
              text/javascript
              application/javascript
              application/json
              image/svg+xml;

          location / {
              try_files $$uri $$uri/ /index.html;
          }

          location /assets/ {
              expires 1y;
              add_header Cache-Control "public, immutable";
              access_log off;
          }

          location ~* \.html$ {
              expires -1;
              add_header Cache-Control "no-store, no-cache, must-revalidate";
          }

          location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
              expires 6M;
              add_header Cache-Control "public";
              access_log off;
          }

          add_header X-Frame-Options "SAMEORIGIN" always;
          add_header X-Content-Type-Options "nosniff" always;
          add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      }
